<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Gr√°ficas ‚Äî Transit Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--accent:#d4001f;--accent-dark:#a30018;--dark:#0b1220;--muted:#6b7280;--bg:#f0f2f5;--card:#ffffff}
        html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
        body{background:var(--bg);color:var(--dark)}

        /* --- HEADER & NAV --- */
        .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 28px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100}
        .brand{display:flex;align-items:center;gap:10px}
        .logo{width:36px;height:36px;border-radius:6px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
        
        nav { display: flex; gap: 5px; }
        nav a{color:var(--muted);text-decoration:none;font-weight:500; font-size: 14px; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;}
        nav a:hover { background: #eee; color: var(--accent); }
        nav a.active { color: var(--accent); background: #fff0f2; }

        /* --- LAYOUT --- */
        .main-container {
            padding: 30px 4vw;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-section { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: end; }
        .header-section h1 { margin: 0; font-size: 28px; font-weight: 800; color: #1a1a1a; }
        .header-section p { margin: 5px 0 0; color: var(--muted); font-size: 14px; }

        /* --- GRID DE GR√ÅFICAS --- */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            height: 400px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chart-card.full-width { grid-column: 1 / -1; height: 450px; }
        
        .chart-header { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chart-header h3 { margin: 0; font-size: 16px; font-weight: 700; color: var(--dark); }
        .chart-wrapper { flex: 1; position: relative; width: 100%; height: 100%; }

        /* --- NUEVA SECCI√ìN: TABLA DE REPORTES --- */
        .reports-section {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #fafafa;
        }
        .table-header h2 { margin: 0; font-size: 18px; font-weight: 700; }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            text-align: left;
        }

        th {
            background: #f8f9fa;
            color: var(--muted);
            font-weight: 600;
            padding: 12px 20px;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }

        td {
            padding: 14px 20px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            vertical-align: top;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fafb; }

        .col-fecha { width: 150px; color: var(--muted); font-size: 12px; font-weight: 500;}
        .col-asunto { font-weight: 600; color: var(--dark); width: 25%; }
        .col-contenido { line-height: 1.5; }

        .btn{background:var(--accent);color:#fff;padding:10px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:600;text-decoration: none; font-size: 13px; transition: background 0.2s;}
        
        @media(max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            nav { display: none; }
        }
    </style>
</head>
<body>

    <header class="topbar">
        <div class="brand">
            <div class="logo">T</div>
            <div style="font-weight:800; font-size:18px;">Transit</div>
        </div>
        <nav>
            <a href="index.html">Inicio</a>
            <a href="index2.html">Gr√°ficas</a>
            <a href="index3.html">Formulario</a>
            <a href="help.html">Help</a>
            <a href="respuestas.html" class="active">Gr√°ficas de quejas del formulario</a>
        </nav>
    </header>

    <main class="main-container">
        <div class="header-section">
            <div>
                <h1>Dashboard Visual</h1>
                <p>Generaci√≥n din√°mica de gr√°ficas y reportes recibidos.</p>
            </div>
            <a href="index3.html" class="btn">+ Nuevo Reporte</a>
        </div>

        <div id="charts-container" class="charts-grid">
            <p style="grid-column:1/-1; text-align:center; color:#999;">Cargando visualizaciones...</p>
        </div>

        <div class="reports-section">
            <div class="table-header">
                <h2>üìã Buz√≥n de Reportes Recientes</h2>
            </div>
            <div class="table-responsive">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Nombre</th>
                            <th>Asunto</th>
                            <th>Contenido del Reporte</th>
                        </tr>
                    </thead>
                    <tbody id="reports-body">
                        <tr><td colspan="4" style="text-align:center; padding:20px;">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // ============================================================
        // PARTE 1: GR√ÅFICAS
        // ============================================================
        const graficas = [
            { 
                url: '/respuestas.json', // Usamos /api/datos para asegurar datos frescos
                titulo: 'Historial de Reportes (Tiempo Real)', 
                tipo: 'line', 
                grande: true, 
                esTiempo: true 
            },
            { 
                url: 'tablas/top30.json', 
                titulo: 'Top 30 Palabras Clave', 
                tipo: 'bar',
                ejeX: 'word', ejeY: 'count' 
            },
            { 
                url: 'tablas/content_top30.json', 
                titulo: 'Contenido Recurrente', 
                tipo: 'bar',
                color: '#3b82f6',
                ejeX: 'word', ejeY: 'count'
            },
            { 
                url: 'tablas/top10_triples.json', 
                titulo: 'Top 10 Triples', 
                tipo: 'doughnut',
                ejeX: 'triple', ejeY: 'count'
            }
        ];

        async function cargarDashboard() {
            const container = document.getElementById('charts-container');
            container.innerHTML = ''; 

            for (let i = 0; i < graficas.length; i++) {
                const config = graficas[i];
                const cardId = `chartCanvas-${i}`;
                const claseExtra = config.grande ? 'full-width' : '';
                
                container.innerHTML += `
                    <div class="chart-card ${claseExtra}">
                        <div class="chart-header"><h3>${config.titulo}</h3></div>
                        <div class="chart-wrapper"><canvas id="${cardId}"></canvas></div>
                    </div>`;
            }

            for (let i = 0; i < graficas.length; i++) {
                const config = graficas[i];
                const ctx = document.getElementById(`chartCanvas-${i}`).getContext('2d');
                
                try {
                    const response = await fetch(config.url);
                    if(!response.ok) continue;
                    let rawData = await response.json();
                    if(!Array.isArray(rawData) || rawData.length === 0) continue;

                    let etiquetas = [], valores = [];

                    if (config.esTiempo) {
                        const conteo = {};
                        rawData.forEach(item => {
                            if(item.fecha) {
                                const dia = item.fecha.split('T')[0];
                                conteo[dia] = (conteo[dia] || 0) + 1;
                            }
                        });
                        etiquetas = Object.keys(conteo).sort();
                        valores = etiquetas.map(d => conteo[d]);
                    } else {
                        const llaveTexto = config.ejeX || Object.keys(rawData[0])[0];
                        const llaveNum = config.ejeY || Object.keys(rawData[0])[1];
                        const datosLimitados = rawData.slice(0, 15); 
                        etiquetas = datosLimitados.map(d => d[llaveTexto]);
                        valores = datosLimitados.map(d => d[llaveNum]);
                    }

                    new Chart(ctx, {
                        type: config.tipo || 'bar',
                        data: {
                            labels: etiquetas,
                            datasets: [{
                                label: 'Frecuencia',
                                data: valores,
                                backgroundColor: config.tipo === 'doughnut' 
                                    ? ['#d4001f', '#0b1220', '#6b7280', '#e5e7eb', '#ef4444']
                                    : (config.color || '#d4001f'),
                                borderColor: (config.color || '#d4001f'),
                                borderWidth: 1,
                                tension: 0.4, fill: config.tipo === 'line'
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: config.tipo === 'doughnut' } },
                            scales: config.tipo === 'doughnut' ? {} : { y: { beginAtZero: true } }
                        }
                    });
                } catch (e) { console.error(e); }
            }
        }

        // ============================================================
        // PARTE 2: TABLA DE REPORTES (CORREGIDO)
        // ============================================================
        async function cargarTablaReportes() {
            const tbody = document.getElementById('reports-body');
            
            try {
                // Usamos /api/datos en lugar de /respuestas.json para leer
                // directamente del servidor y evitar cach√©
                const response = await fetch('/respuestas.json'); 
                
                if (!response.ok) throw new Error('Error cargando datos');
                
                const data = await response.json();

                if (!Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#888;">No hay reportes registrados a√∫n.</td></tr>';
                    return;
                }

                data.reverse(); // Los m√°s recientes primero

                let htmlFilas = '';

                data.forEach(item => {
                    let fechaBonita = 'Sin fecha';
                    if (item.fecha) {
                        const d = new Date(item.fecha);
                        fechaBonita = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }

                    const asunto = (item.asunto || 'Sin asunto').replace(/</g, "&lt;");
                    const contenido = (item.contenido || 'Sin contenido').replace(/</g, "&lt;");
                    const nombre = (item.nombre || 'An√≥nimo').replace(/</g, "&lt;");

                    // ---> AQU√ç ESTABA EL ERROR ANTES: Us√°bamos ${fecha} y debe ser ${fechaBonita}
                    htmlFilas += `
                        <tr>
                            <td class="col-fecha">${fechaBonita}</td>
                            <td style="font-weight:600;">${nombre}</td>
                            <td class="col-asunto">${asunto}</td>
                            <td class="col-contenido">${contenido}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = htmlFilas;

            } catch (error) {
                console.error("Error tabla:", error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:red;">Error al cargar la lista de reportes.</td></tr>';
            }
        }

        cargarDashboard();
        cargarTablaReportes();

    </script>
</body>
</html>